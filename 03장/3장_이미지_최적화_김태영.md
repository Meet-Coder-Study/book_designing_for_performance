# 3장 이미지 최적화

대부분 사이트에서 페이지 내에 다양하게 이미지가 사용되고 있고 이는 적절한 최적화를 통하면 사이트의 속도를 가장 빨리, 눈에 띄게 개선할 수 있게 된다.

이번 장에선 이미지를 사용하는데 있어 다음 항목을 가이드 한다.

- 이미지 포맷 고르기
- 이미지 요청 대체하기
- 이미지 최적화를 위한 계획 수립과 수행

## 이미지 포멧 고르기

책에서 이미지 포멧을 결정하기 전 고려해야 하는 사항에 대해 좋은 가이드를 제안해주고있다.

- 눈에 띄는 품질 저하 없이 이미지를 압축할 수 있는가?
- 얼마나 많은 색상이 필요한가?
- 이미지를 더 단순하게 할 방법은 없는가?
- 이미지가 투명해야 하는가?
- 애니메이션이 필요한가?
- 이미지가 화면에 표시될 때 최대 높이와 너비는 어떻게 되는가?
- 사이트에서 어떤 용도로 이미지를 사용할 것인가?

책에서 제안하는 이미지 포멧에 대해서는 개인적인 경험 위주로 정리해봤다.

### 1. JP(E)G

- 색상을 많이 가지는 이미지, 즉 “사진”같은 이미지에 적절하게 사용할 수 있다.
- 압축할 때 손실 압축 기반으로 압축된다.
    - 이는 압축 시 이미지 색상이 날아갈 수 있다.
- 압축하는 화질에 따라 사람의 눈에는 크게 차이가 나지 않는다.
    - 경험상, 붉은색 계절은 압축 시 손실이 눈에띄게 컸다.
- 포토샵의 “웹용으로 저장하기”라는 기능을 통해 웹에 최적화된 JPG 이미지를 추출할 수 있다.
    - 품질을 추출할 때 80으로 추출했을때가 가장 무난하고 “사람의 눈”으로 봤을 때 색상의 차이가 크게 없었다.
    - 책에도 나와있지만 추출 후 외부 압축 Tool을 이용해 한번 더 이미지를 압축할 수 있지만, 의도한 것과 다르게 색감이 더 많이 손실되어 오히려 역효과를 보는 경우도 있었다.

포토샵에서 추출 후 추가 압축과, 포토샵 이외의 Tool에서는 이미지 추출 후 [TinyPNG](https://tinypng.com/) 같은 사이트에서 이미지를 압축할 수 있으며 꽤나 준수한 압축률과 비교적 적은 이미지 손실을 경험할 수 있었다.

#### 프로그레시브 JPEG?

일반 JPEG는 이미지가 위에서부터 아래로 단계별로 로드가 되는데 프로그레시브 JPEG는 저품질 -> 고품질로 변화하며 로드 된다.
이렇게 보면 프로그레시브 JPEG를 사용하는게 좋아보이겠지만 다음 사항을 고려해야한다.

1. 프로그레시브 JPEG 로딩을 지원하지 않는 브라우저에서는 이미지가 완전히 로드되기 전까지 아무것도 보여주지 않는다.
2. 파일을 여러번 스캔하는 방식 특성 상, CPU 파워를 많이 소모하기 때문에 과도한 사용은 오히려 성능이 안좋을 수 있다.
3. 프로그레시브를 적용함으로 오히려 용량이 늘어날 수 있다.

> 책에서 제안하는 스머시잇 사이트는 운영을 종료한 것 같아 [이 사이트](https://coding.tools/progressive-jpeg)를 추천드립니다.

### 2. GIF

- 흔히 "움짤"로 많이 사용되는 이미지 확장자로, 프레임 안에 256색만 지원한다.
- JPEG와 다르게 무손실 파일 포멧이다.
- CSS 애니메이션으로 대체할 수 없을 때 사용된다.
  - 가능하다면 더 용량이 작고 성능이 좋은 CSS로 만드는게 좋다.
- 디더링 옵션을 사용하면 좀 더 부드러운 GIF를 만들 수 있으나 그만큼 용량이 증가한다.

### 3. PNG

- GIF를 개선하고자 나온 포멧으로 무손실 이미지 포멧이다.
- GIF와 다르게 수직 패턴도 압축하기 때문에 용량이 더 줄어든다.
- 투명 이미지를 사용한다면 베스트 선택이다.
  - PNG-8은 이미지가 색상이 적을 때 사용하면 좋다.
  - PNG-24는 색상 제한이 없다. 그만큼 모든 색을 가지기 때문에 용량이 커질 수 있고 PNG-8/24를 고르지 못하는 Tool은 24를 기본으로 추출해준다.
- PNG파일은 추출 후 반드시 외부 툴을 이용해 압축을 해주는게 좋다.

### 추가 압축
앞서 내용에서 중간중간 외부 툴을 사용한 압축을 언급했는데, 아무리 포토샵으로 웹용으로 내보낸다 해도 외부 압축 툴을 통해 최적의 압축을 한번 더 돌려주는게 좋다.

책에는 없지만 추가 압축 후 개인적으로 다음 항목을 확인한다.

- 사람의 시각적으로 색감의 변화는 없었는지 before/after를 확인한다.
- 간혹 프로그레시브를 자동으로 적용해주는 외부 툴은 오히려 이미지 용량을 증가시킨다. 따라서 압축 이후 용량을 다시 비교해본다.
- 그림자 효과가 들어간 이미지의 경우, 잘못된 압축으로 인해 그라데이션의 색감이 손실되는 경우가 있어서 이미지 주변에 흰색 점이 생기는 경우가 있어 주의해야한다.

> 이외에 브라우저가 지원하는 이미지 포멧으로 [**구글의 Webp**](https://ko.wikipedia.org/wiki/WebP), [**MS의 JPEG XR**](https://ko.wikipedia.org/wiki/JPEG_XR) 등이 있는데, 서비스를 운영할 때 가능하다면 브라우저가 지원하는 최적의 이미지를 사용하여 서비스 하는게 가장 베스트 일 것 같다.
> <br>이러한 이미지의 사용은 [&lt;picture&gt;](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/picture) 태그를 사용하면 좋다.


## 이미지 요청 대체하기

이미지의 압축도 중요하나, 이미지의 호출 자체를 줄이는 것도 매우 중요하다.
이미지 요청을 줄이는 대표적인 방법으로는 아래 두가지 방법이 있다.

- 스프라이트 이미지 사용
- CSS3 대체, 데이터 URI, SVG 파일 변환

### 스프라이트

**"가장 빠른 요청은 처음부터 요청하지 않는 것이다"**

라는 말이 있는데, 낱개의 이미지를 하나의 이미지로 뭉쳐 여러번 호출하는 것이 아닌 한번의 호출로 여러 이미지를 불러오는게 "스프라이트" 기법이다.

스프라이트는 "로고, 아이콘" 등을 모아두고 하나의 이미지 파일을 만들어 두고 CSS로 제어해서 사용할 수 있다.
단, CSS로 제어하기 때문에 낱개의 이미지를 사용해서 호출하는것 보다는 손이 더 많이 간다.

> 스프라이트 기법을 사용중인 서비스 : [티스토리](https://www.tistory.com/), [다음](https://www.daum.net/)

스프라이트 이미지를 사용하는 경우, 이미지가 "배경 이미지"로 들어가기 때문에 만약 버튼, 로고 등에 스프라이트 이미지를 사용했다면 스크린 리더가 읽을 수 있는 텍스트를 제공해주어야 한다.
<br>*물론, 단순 비쥬얼적 이미지는 예외이다.*

```html
<a href="https://daum.net">티스토리 바로가기</a>
```

```css
a {
  background-image: url(https://t1.daumcdn.net/tistory_admin/static/top/pcrtn/img_common_tistory_200910.png);
  background-size: 200px 180px;
  background-position: 0 0;
}
```

이런 코드가 있다고 가정했을 때 "티스토리 바로가기" 라는 글자가 보이지 않아야 하는데, `text-indent`와 `overflow`를 사용해 글자를 숨길 수
몇가지 방법을 사용하여 처리할 수 있다.

1. `overflow: hidden;`, `text-indent: -1000%` 를 사용한 글자 숨기기
2. `screen-reader-text` class 등을 사용한 추가 마크업
3. `aria-label`을 이용한 이름 지정

책에선 1번을 사용한 방법을 안내 해주고 있어 2, 3번의 사용법을 공유한다.

#### screen-reader-text class
스크린 리더 텍스트에 대한 설명은 [이곳](https://make.wordpress.org/accessibility/handbook/markup/the-css-class-screen-reader-text/)에서 자세히 설명하고 있다.

class를 추가하는 것이기 떄문에 별도의 태그로 감싸고 class를 추가해야한다.

```html
<a href="https://daum.net">
  <span class="screen-reader-text">티스토리 바로가기</span>
</a>
```

```css
.screen-reader-text {
  border: 0;
  clip: rect(1px, 1px, 1px, 1px);
  clip-path: inset(50%);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
  word-wrap: normal !important;
}
```

#### aria-label

웹 접근성인 기술인, [Aria 특성](https://developer.mozilla.org/ko/docs/Web/Accessibility/ARIA)을 사용한 마크업 방식이다.
Aria가 제공하는 여러 속성 중 **label** 이라는 속성을 사용하면 접근성 기기에게 버튼 이름을 안내 해줄 수 있다.

```html
<a href="https://daum.net" aria-label="티스토리 바로가기"></a>
```

이러한 방법을 사용해, 스프라이트 기법을 사용해 이미지 호출을 줄이고 사용자에게는 "로고"를 보여주고 스크린 리더와 같은 접근성 기기에는 버튼의 이름을 안내 해줄수 있으니, 자신의 서비스에 맞게 사용하면 될 것 같다.

그렇다고 반드시 스프라이트 이미지를 사용 할 필요는 없다.
<br>스프라이트 이미지는 한 아이콘만 수정 되더라도 전체 이미지에 영향이 가기 때문에 캐시 생성에 영향을 줄 수 있고 현재 페이지를 보고 있는 사용자에게 필요하지 않는 이미지까지 보일 수 있어 불필요한 크기의 이미지를 호출하게 될 수도 있다.

### CSS

CSS를 사용하면 이미지 요청 횟수를 더 줄일 수 있다. 또한 이미지 보다 더 빠르게 수정할 수 있고 다양한 색상과 투명성을 제어할 수 있다.
<br>그리고 서버의 gzip 압축을 사용하면 CSS는 알아서 최적화 되니 이미지의 최적화보다 훨씬 다루기 수월하다고 볼 수 있다.

책에선 background에 대해 자세히 다루고 있어 이 외에 대체할 수 있는 것들을 몇가지 소개한다.

1. **border-radius**
   간단하게 이미지의 테두리를 둥글게 하는 효과를 넣을 수 있다.
   <br>이미지 자체에 테두리를 둥글게 작업하면, "투명도"를 신경써야 하기 때문에 이미지 추출에 더 신경을 써야하는데 그 수고를 덜어준다.
2. **box-shadow**
   radius와 마찬가지로 shadow로 인해 발생하는 이미지의 그라데이션, 투명도를 CSS로 대체할 수 있다.
3. spinner
   페이지를 로딩하거나 무언가를 로딩할 때 사용하는 스피너는 CSS로 쉽게 대체할 수 있다.
4. Keyframes
   단순한 효과의 경우 GIF를 사용한 애니메이션 보다 CSS Keyframes을 사용한 애니메이션이 성능적으로나 JavaScript와의 연계로나 더 사용하기 좋은 경우도 있다.

이 외에도 다양한 기법이 있겠지만, 그렇다고 너무 많은 CSS의 사용은 화면을 갱신하는데 있어 "쟁크"가 생길 수 있으니 주의해야한다.

#### 데이터 URI와 base64로 인코딩한 이미지

매우 작고 단순한 이미지의 경우 base64로 인코딩해 사용하는것도 방법 중 하나다.

[부트스트랩](https://getbootstrap.com/docs/5.2/forms/validation/#supported-elements)을 보면 base64 인코딩을 적절히 사용하고 있으니 참고해보면 좋겠다.

단, 이 방식으로 이미지를 사용할 경우 이미지를 캐싱할 수 없고 CSS의 코드가 길어지는 문제가 있으니 적용 전/후로 성능 측정해 적용 이점을 확인 해보는게 좋다.

### SVG

단일 색상의 아이콘이나 이미지는 확장 가능한 벡터 그래픽으로 교체해서 사용하는것도 방법이다.

**SVG의 기본 경로, 모양, 글꼴, 색상 등은 XML을 사용해 정의된다.**

SVG의 주 장점으로는

- 비트맵 이미지와 달리 확대/축소가 가능한 벡터 이미지 이기 때문에 고해상도 에서도 깨짐 없이 보여준다.
- "코드"로 제공되기 때문에 src 호출 대신 인라인 코드로 작성할 수 있다.
- CSS를 적용할 수 있어 비트맵 이미지와 다르게 hover, active 등 효과를 추가할 수 있다.

SVG를 추출하고 사용할땐 이미지와 마찬가지로 [SVGO](https://jakearchibald.github.io/svgomg/)와 같은 외부 Tool을 사용해 웹용으로 최적화 해주는 과정이 필요하다.

SVG는 인라인 코드로 넣어 CSS, JS로 다양하게 활용할 수 있지만, 간단히 이미지 처럼 `img`태그로 불러와 사용할 수 있다.
<br>img로 호출해도 백터파일의 형식은 유지하기 때문에 확대/축소해도 깨짐 없이 깔끔하게 보여준다.

또한 SVG는 [IcoMoon](https://icomoon.io/)과 같은 서비스를 사용하면, 나만의 [Font Awesome](https://fontawesome.com/icons)을 만들어 "글꼴"처럼 사용할 수 있다.
<br>"글꼴"이기 때문에 포토샵, 피그마, MS Office 등 외부 도구에서도 사용할 수 있다!

SVG에 대한 다양한 활용법은 ["웹에서 SVG 사용하기 실습 가이드"](https://svgontheweb.com/ko/)를 꼭 읽어보길 추천한다.

## 이미지 최적화를 위한 계획 수립과 수행

책에선 설계 단계부터 세심하게 계획 해야 이미지를 효율적으로 만들 수 있다고 한다.

서비스를 꾸려나갈 때 각 포지션의 사람들과 논의하여 최소한 다음 규칙은 지켜 나가는게 좋겠다.

1. 정기 검사 일정
   - 스프라이트 이미지 최적화
   - svg, webp 등 대체 기술 검토
   - 이미지 압축 확인
   - 이미지 사이즈 확인
2. 스타일 가이드
   - 서비스 내 규칙 만들기
3. 협업
   - 최적화 지식 공유 등을 통한 서비스 개선
